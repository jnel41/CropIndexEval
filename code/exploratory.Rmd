---
title: "Iowa Productivity Index Comparison"
author: "J. Stephenson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)#,
                      #fig.width = 12,
                      #fig.height = 12)

library("tidyverse"); theme_set(theme_bw())
library("lme4")
library("lmerTest")
library("emmeans")
library("ggResidpanel")

options(width = 200)

dir.create("fig", showWarnings = FALSE)
```

```{r create_cpi, cache.extra=tools::md5sum("../data/raw/ia_cpi.csv")}
## Generate dataframe
ia_CPI <- read_csv("../data/raw/ia_cpi.csv") %>%
  mutate(NCCPIx100 = NCCPIall * 100,
         cpi_diff = abs(OCProdIdx - NCCPIx100))


```
```{r explore_cpi, dependson="create_cpi"}
## explore summary statistics of dataset
str(ia_CPI)
summary(ia_CPI)

```


```{r explore_cpi, dependson="create_cpi"}
ggplot(ia_CPI, aes(x = OCProdIdx, y = NCCPIx100)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "CSR2 vs NCCPI", x = "CSR2", y = "NCCPI")

```

```{r cpi_cor, dependson = "create_cpi", eval = FALSE, echo = FALSE}
cor.test(ia_CPI$OCProdIdx, ia_CPI$NCCPIx100, method = "pearson")  # linear correlation
cor.test(ia_CPI$OCProdIdx, ia_CPI$NCCPIx100, method = "spearman") # rank-based (non-parametric)
```

```{r cpi_lm, dependson = "create_cpi", eval = FALSE, echo = FALSE}
lm_cpi <- lm(NCCPIx100 ~ OCProdIdx, data = ia_CPI)
summary(lm_cpi)

ia_CPI$residuals <- residuals(lm_cpi)

outliers <- ia_CPI[abs(ia_CPI$residuals) >2 * sd(ia_CPI$residuals),]

outliers
```

```{r low_agree, dependson = "create_cpi", eval = FALSE, echo = FALSE}
threshold <- quantile(ia_CPI$cpi_diff, 0.90)
low_agree <- subset(ia_CPI, cpi_diff >= threshold)

low_agree %>%
  group_by(MUsymbol, DrainCls) %>%
  summarize(mean_CSR2 = mean(OCProdIdx),
            mean_NCCPI = mean(NCCPIx100),
            mean_diff = mean(cpi_diff),
            n=n())

ggplot(ia_CPI, aes(x = OCProdIdx, y = NCCPIx100, color = cpi_diff > 0.2)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(title = "CSR2 vs NCCPI: Highlighting Low Agreement Points",
       color = "Low Agreement")
```